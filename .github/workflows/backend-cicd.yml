name: deploy backend to GCS
on:
  push:
    paths: [ 'backend/' ]
jobs:
    deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: read  # Allow reading the repository contents
            id-token: write  # Allow generating an ID token for GCP authentication
        steps:
            # 1. Test GCP Auth
            - name: Test GCP Auth
              run: |
                gcloud auth list
                gcloud config list
                ##Test bucket access
                gsutil ls gs://backend-static-hosting
                gsutil ls gs://backend-static-hosting/backend
            -   uses: actions/checkout@v4
            
            # 2. set up legacy authentication to Google Cloud using JSON key
            -   name: Authenticate to Google Cloud
                uses: google-github-actions/auth@v1
                with:
                    credentials_json: ${{ secrets.GCP_BACKEND_KEY }}
            
            # 3. COnfiguring Docker to use GCloud
            -   name: Configure Docker to use gcloud
                run: |
                    gcloud auth configure-docker --quiet

            # 4. Build and push Docker image to GCR
            -   name: Build and Push Docker Image
                run: |
                    docker build -t gcr.io/indigo-skyline-467604-d6/backend:latest ./backend
                    docker push gcr.io/indigo-skyline-467604-d6/backend:latest
            
            # 5. Deploy to Cloud Run
            -   name: Deploy to Cloud Run
                run: |
                    gcloud run deploy backend:latest \
                    --image gcr.io/indigo-skyline-467604-d6/backend:latest \
                    --platform managed \
                    --region asia-south2 \
                    --port 5000 \
                    --allow-unauthenticated
            
            # upload backend files to GCS
            -   name: Upload Backend to GCS
                uses: google-github-actions/upload-cloud-storage@v2
                with:
                    path: './backend'  # Target backend folder
                    destination: backend-static-hosting/backend
                    parent: false
                    cacheControl: 'public, max-age=3600, immutable'
                    process_gcloudignore: false  # Do not process .gcloudignore file

            # verify sync
            - run: gsutil ls -r gs://backend-static-hosting/backend

                
                